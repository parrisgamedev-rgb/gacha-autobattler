# v0.18.1 Bug Fixes & Polish Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Fix 2 bugs, 2 design flaws, and add 8 UI polish improvements to bring the game from "functional" to "finished."

**Architecture:** Modular additions to existing systems. New `CurrencyBar` reusable component. New `CheatManager` autoload for global cheats. Combat Power (CP) calculation added to `PlayerData`. UI screens updated incrementally.

**Tech Stack:** Godot 4.5, GDScript, existing UITheme/UISpriteLoader patterns

---

## Task 1: Fix Achievements Screen Empty Bug

**Files:**
- Modify: `scripts/core/achievement_manager.gd:25-38`
- Test: Manual - open Achievements screen, verify achievements appear

**Context:** The `AchievementManager._load_achievements()` uses `DirAccess` which may fail in exported builds or have path issues. The achievements exist at `resources/achievements/*.tres` (9 files confirmed).

**Step 1: Investigate the issue**

Read the achievement loading code and check if `DirAccess.open()` is returning null or finding no files.

**Step 2: Fix by using explicit resource loading**

Replace directory scanning with explicit loading of known achievement files:

```gdscript
func _load_achievements():
	"""Load all achievement resources."""
	var achievement_paths = [
		"res://resources/achievements/first_blood.tres",
		"res://resources/achievements/warrior.tres",
		"res://resources/achievements/veteran.tres",
		"res://resources/achievements/speed_demon.tres",
		"res://resources/achievements/collector.tres",
		"res://resources/achievements/gear_up.tres",
		"res://resources/achievements/chapter_1_clear.tres",
		"res://resources/achievements/chapter_2_clear.tres",
		"res://resources/achievements/chapter_3_clear.tres"
	]

	for path in achievement_paths:
		var achievement = load(path) as AchievementData
		if achievement:
			all_achievements.append(achievement)

	print("[AchievementManager] Loaded ", all_achievements.size(), " achievements")
```

**Step 3: Test**

Run: Launch game, go to Achievements screen
Expected: 9 achievements visible with correct categories and progress

**Step 4: Commit**

```bash
git add scripts/core/achievement_manager.gd
git commit -m "fix: load achievements explicitly instead of directory scan"
```

---

## Task 2: Fix Gear Card Tap Bug

**Files:**
- Modify: `scripts/ui/gear_inventory_screen.gd:173-178`
- Modify: `scripts/ui/collection_screen.gd:646-647`
- Test: Manual - tap gear cards in both screens

**Context:** Gear cards have invisible buttons that connect to `_on_gear_selected`, but the detail panel may not be opening properly or the button isn't receiving clicks.

**Step 1: Investigate gear_inventory_screen.gd**

The gear card creates an invisible button at line 173-178. Check if signal connection works and if `_update_detail_panel()` is called correctly.

**Step 2: Fix gear inventory screen**

Ensure the button is properly sized and clickable. The issue may be that `btn.modulate = Color(1, 1, 1, 0)` makes it fully invisible but should still receive clicks. Add explicit mouse filter:

```gdscript
# In _create_gear_card, after creating btn
btn.mouse_filter = Control.MOUSE_FILTER_STOP
btn.focus_mode = Control.FOCUS_NONE
```

**Step 3: Fix collection screen gear slots**

In `collection_screen.gd`, the gear slot buttons in `_update_gear_slots()` should also trigger the upgrade UI. Currently clicking opens gear select - add a way to tap equipped gear to upgrade it.

**Step 4: Test**

Run: Launch game, go to Gear Inventory, tap a gear card
Expected: Detail panel appears with enhance button

Run: Launch game, go to Collection, select a unit, tap equipped gear
Expected: Gear select panel or upgrade option appears

**Step 5: Commit**

```bash
git add scripts/ui/gear_inventory_screen.gd scripts/ui/collection_screen.gd
git commit -m "fix: ensure gear cards respond to tap/click"
```

---

## Task 3: Add Unit Combat Power (CP) System

**Files:**
- Modify: `scripts/core/player_data.gd` (add new function)
- Test: Manual - check CP values appear correctly

**Step 1: Add CP calculation function to PlayerData**

Add after `get_unit_stats_at_level()` (~line 618):

```gdscript
func calculate_unit_cp(unit_entry: Dictionary) -> int:
	"""Calculate Combat Power for a unit including gear."""
	if unit_entry.is_empty():
		return 0

	var unit_data = unit_entry.unit_data as UnitData
	var level = unit_entry.get("level", 1)
	var imprint_level = unit_entry.get("imprint_level", 0)

	# Get base stats at level
	var stats = get_unit_stats_at_level(unit_data, level, imprint_level)

	# Base CP from stats (HP weighted less since it's larger numbers)
	var base_cp = int(stats.max_hp / 10.0) + stats.attack + stats.defense + stats.speed

	# Add gear bonuses
	var gear_bonuses = get_gear_bonuses(unit_entry.instance_id)
	var gear_cp = 0
	gear_cp += int(gear_bonuses.flat_hp / 10.0)
	gear_cp += gear_bonuses.flat_attack
	gear_cp += gear_bonuses.flat_defense
	gear_cp += gear_bonuses.flat_speed
	# Percentage bonuses add to base
	gear_cp += int(stats.max_hp * gear_bonuses.percent_hp / 10.0)
	gear_cp += int(stats.attack * gear_bonuses.percent_attack)
	gear_cp += int(stats.defense * gear_bonuses.percent_defense)
	gear_cp += int(stats.speed * gear_bonuses.percent_speed)

	return base_cp + gear_cp
```

**Step 2: Test**

Run: In debugger, call `PlayerData.calculate_unit_cp(PlayerData.owned_units[0])`
Expected: Returns a reasonable integer (e.g., 50-500 depending on level/gear)

**Step 3: Commit**

```bash
git add scripts/core/player_data.gd
git commit -m "feat: add unit Combat Power (CP) calculation"
```

---

## Task 4: Add Auto-Select Team Feature

**Files:**
- Modify: `scripts/ui/team_select_screen.gd`
- Test: Manual - click Auto Select button

**Step 1: Add auto-select button to UI**

In `_ready()`, after other button connections (~line 35), add:

```gdscript
var auto_select_btn = get_node_or_null("BottomBarPanel/BottomBar/AutoSelectButton")
if auto_select_btn:
	auto_select_btn.pressed.connect(_on_auto_select)
```

**Step 2: Add the auto-select function**

Add new function:

```gdscript
func _on_auto_select():
	AudioManager.play_ui_click()

	# Get all units with their CP
	var units_with_cp = []
	for unit_entry in PlayerData.get_owned_unit_list():
		var cp = PlayerData.calculate_unit_cp(unit_entry)
		units_with_cp.append({"entry": unit_entry, "cp": cp})

	# Sort by CP descending
	units_with_cp.sort_custom(func(a, b): return a.cp > b.cp)

	# Clear current selection
	selected_instance_ids.clear()

	# Select top 3 units
	for i in range(min(3, units_with_cp.size())):
		selected_instance_ids.append(units_with_cp[i].entry.instance_id)

	# Refresh UI
	_populate_units()
	_update_ui()
```

**Step 3: Add button to scene (or create programmatically)**

If button doesn't exist in scene, create it programmatically in `_ready()`:

```gdscript
# Create auto-select button next to start button
var auto_btn = Button.new()
auto_btn.name = "AutoSelectButton"
auto_btn.text = "AUTO SELECT"
auto_btn.custom_minimum_size = Vector2(150, 50)
auto_btn.pressed.connect(_on_auto_select)
UISpriteLoader.apply_button_style(auto_btn, UISpriteLoader.ButtonColor.GOLD, "ButtonA")
auto_btn.add_theme_font_size_override("font_size", UITheme.FONT_BODY)

var bottom_bar = get_node_or_null("BottomBarPanel/BottomBar")
if bottom_bar:
	bottom_bar.add_child(auto_btn)
	bottom_bar.move_child(auto_btn, 1)  # After instructions label
```

**Step 4: Test**

Run: Go to Team Select, click Auto Select
Expected: Top 3 units by CP are selected

**Step 5: Commit**

```bash
git add scripts/ui/team_select_screen.gd
git commit -m "feat: add auto-select team by Combat Power"
```

---

## Task 5: Add CP Display to Unit Cards

**Files:**
- Modify: `scripts/ui/team_select_screen.gd:462-578` (_create_unit_card)
- Modify: `scripts/ui/collection_screen.gd:110-234` (_create_unit_card)
- Test: Manual - verify CP shows on cards

**Step 1: Add CP to team_select_screen unit cards**

In `_create_unit_card()`, after the element label (~line 554), add:

```gdscript
# Combat Power
var cp = PlayerData.calculate_unit_cp(unit_entry)
var cp_label = Label.new()
cp_label.text = "CP: " + str(cp)
cp_label.position = Vector2(0, 175)
cp_label.size = Vector2(card_width, 20)
cp_label.horizontal_alignment = HORIZONTAL_ALIGNMENT_CENTER
cp_label.add_theme_font_size_override("font_size", UITheme.FONT_CAPTION)
cp_label.add_theme_color_override("font_color", UITheme.GOLD)
card.add_child(cp_label)
```

**Step 2: Add CP to collection_screen unit cards**

In `_create_unit_card()`, after the XP bar section (~line 225), add similar CP label.

**Step 3: Test**

Run: Go to Collection and Team Select screens
Expected: Each unit card shows "CP: X" value

**Step 4: Commit**

```bash
git add scripts/ui/team_select_screen.gd scripts/ui/collection_screen.gd
git commit -m "feat: display Combat Power on unit cards"
```

---

## Task 6: Create Persistent Currency Bar Component

**Files:**
- Create: `scripts/ui/currency_bar.gd`
- Create: `scenes/ui/currency_bar.tscn`
- Test: Manual - verify bar appears and updates

**Step 1: Create the currency bar script**

```gdscript
extends HBoxContainer
## Reusable currency display bar

@onready var gems_label = $GemsContainer/GemsLabel
@onready var gold_label = $GoldContainer/GoldLabel
@onready var materials_label = $MaterialsContainer/MaterialsLabel
@onready var stones_label = $StonesContainer/StonesLabel

func _ready():
	_apply_theme()
	_update_display()
	# Connect to PlayerData changes (we'll poll on visibility for now)

func _process(_delta):
	if visible:
		_update_display()

func _update_display():
	if gems_label:
		gems_label.text = str(PlayerData.gems)
	if gold_label:
		gold_label.text = str(PlayerData.gold)
	if materials_label:
		materials_label.text = str(PlayerData.level_materials)
	if stones_label:
		stones_label.text = str(PlayerData.enhancement_stones)

func _apply_theme():
	# Style each currency container
	for child in get_children():
		if child is HBoxContainer:
			var label = child.get_node_or_null(child.name.replace("Container", "Label"))
			if label:
				label.add_theme_font_size_override("font_size", UITheme.FONT_CAPTION)
				label.add_theme_color_override("font_color", UITheme.GOLD)
```

**Step 2: Create the scene structure**

Create `scenes/ui/currency_bar.tscn` with:
- HBoxContainer (root, script attached)
  - GemsContainer (HBoxContainer)
    - GemsIcon (TextureRect or Label with icon)
    - GemsLabel (Label)
  - GoldContainer, MaterialsContainer, StonesContainer (same pattern)

**Step 3: Test standalone**

Instance the scene in a test and verify it shows currencies.

**Step 4: Commit**

```bash
git add scripts/ui/currency_bar.gd scenes/ui/currency_bar.tscn
git commit -m "feat: add reusable CurrencyBar component"
```

---

## Task 7: Add Currency Bar to Main Screens

**Files:**
- Modify: `scripts/ui/main_menu.gd`
- Modify: `scripts/ui/collection_screen.gd`
- Modify: `scripts/ui/team_select_screen.gd`
- Modify: `scripts/ui/gacha_screen.gd`
- Modify: `scripts/ui/gear_inventory_screen.gd`
- Modify: `scripts/ui/dungeon_select_screen.gd`
- Test: Manual - verify bar appears on all screens

**Step 1: Add currency bar loading and instantiation pattern**

In each screen's `_ready()`, add:

```gdscript
var CurrencyBarScene = preload("res://scenes/ui/currency_bar.tscn")

# In _ready():
var currency_bar = CurrencyBarScene.instantiate()
var top_bar = get_node_or_null("TopBar") or get_node_or_null("TopBarPanel/TopBar")
if top_bar:
	top_bar.add_child(currency_bar)
```

**Step 2: Adjust positioning as needed per screen**

Each screen may need slight adjustments to fit the bar.

**Step 3: Test each screen**

Run: Navigate through all main screens
Expected: Currency bar visible and accurate on each

**Step 4: Commit**

```bash
git add scripts/ui/*.gd
git commit -m "feat: add CurrencyBar to main screens"
```

---

## Task 8: Add Gear Type Icons

**Files:**
- Modify: `scripts/ui/gear_inventory_screen.gd:198-208` (_get_gear_type_icon)
- Modify: `scripts/core/ui_sprite_loader.gd` (if icons exist in sprite pack)
- Test: Manual - verify icons appear on gear cards

**Step 1: Check existing sprite assets for gear icons**

Look in `assets/sprites/` or the UI sprite pack for weapon/armor/accessory icons.

**Step 2: Update gear type icon function**

If sprites exist, load them. Otherwise, use better text symbols or colored icons:

```gdscript
func _get_gear_type_icon(gear_type: int) -> String:
	match gear_type:
		GearData.GearType.WEAPON:
			return "âš”"  # Sword emoji or custom
		GearData.GearType.ARMOR:
			return "ðŸ›¡"  # Shield emoji or custom
		GearData.GearType.ACCESSORY:
			return "ðŸ’"  # Ring emoji or custom
		_:
			return "?"
```

**Step 3: Add rarity glow/border**

Already implemented via `_get_panel_color_for_rarity()`. Verify colors match design:
- Common: White
- Rare: Blue
- Epic: Purple
- Legendary: Gold

**Step 4: Test**

Run: Go to Gear Inventory
Expected: Gear cards show type icons and rarity-colored borders

**Step 5: Commit**

```bash
git add scripts/ui/gear_inventory_screen.gd
git commit -m "feat: improve gear type icons and rarity display"
```

---

## Task 9: Create Global Cheat Manager

**Files:**
- Create: `scripts/core/cheat_manager.gd`
- Modify: `project.godot` (add autoload)
- Test: Manual - test cheat menu from various screens

**Step 1: Create CheatManager autoload**

```gdscript
extends CanvasLayer
## Global cheat manager accessible from any screen
## Activate with F12 or hold F1 for 2 seconds

var cheat_panel: Panel = null
var f1_hold_time: float = 0.0
const F1_HOLD_THRESHOLD: float = 2.0

func _ready():
	layer = 100  # Always on top
	_create_cheat_panel()
	cheat_panel.visible = false

func _input(event):
	if event is InputEventKey and event.pressed and event.keycode == KEY_F12:
		toggle_panel()

func _process(delta):
	if Input.is_key_pressed(KEY_F1):
		f1_hold_time += delta
		if f1_hold_time >= F1_HOLD_THRESHOLD:
			toggle_panel()
			f1_hold_time = 0.0
	else:
		f1_hold_time = 0.0

func toggle_panel():
	cheat_panel.visible = not cheat_panel.visible

func _create_cheat_panel():
	cheat_panel = Panel.new()
	cheat_panel.custom_minimum_size = Vector2(300, 400)
	cheat_panel.set_anchors_preset(Control.PRESET_CENTER)
	cheat_panel.position = Vector2(-150, -200)
	add_child(cheat_panel)

	var vbox = VBoxContainer.new()
	vbox.set_anchors_preset(Control.PRESET_FULL_RECT)
	vbox.add_theme_constant_override("separation", 8)
	cheat_panel.add_child(vbox)

	# Title
	var title = Label.new()
	title.text = "CHEAT MENU (F12)"
	title.horizontal_alignment = HORIZONTAL_ALIGNMENT_CENTER
	vbox.add_child(title)

	# Currency cheats
	_add_cheat_button(vbox, "+10000 Gems", func(): PlayerData.add_gems(10000))
	_add_cheat_button(vbox, "+10000 Gold", func(): PlayerData.add_gold(10000))
	_add_cheat_button(vbox, "+100 Materials", func():
		PlayerData.level_materials += 100
		PlayerData.save_game())
	_add_cheat_button(vbox, "+100 Stones", func():
		PlayerData.enhancement_stones += 100
		PlayerData.save_game())

	# Unit cheats
	_add_cheat_button(vbox, "Max All Unit Levels", _max_all_units)
	_add_cheat_button(vbox, "Add Random 5â˜… Unit", _add_random_5_star)

	# Progression cheats
	_add_cheat_button(vbox, "Clear All Stages", _clear_all_stages)

	# Close button
	_add_cheat_button(vbox, "CLOSE", toggle_panel)

func _add_cheat_button(parent: Control, text: String, callback: Callable):
	var btn = Button.new()
	btn.text = text
	btn.pressed.connect(callback)
	parent.add_child(btn)

func _max_all_units():
	for i in range(PlayerData.owned_units.size()):
		var unit = PlayerData.owned_units[i]
		var unit_data = unit.unit_data as UnitData
		var max_level = PlayerData.get_max_level(unit_data.star_rating)
		PlayerData.owned_units[i].level = max_level
	PlayerData.save_game()
	print("[CHEAT] Maxed all unit levels")

func _add_random_5_star():
	if PlayerData.unit_pool_5_star.size() > 0:
		var unit = PlayerData.unit_pool_5_star[randi() % PlayerData.unit_pool_5_star.size()]
		PlayerData._add_unit_to_collection(unit)
		PlayerData.save_game()
		print("[CHEAT] Added random 5-star unit")

func _clear_all_stages():
	var stages = ["1-1", "1-2", "1-3", "1-4", "1-5", "2-1", "2-2", "2-3", "2-4", "2-5", "3-1", "3-2", "3-3", "3-4", "3-5"]
	for stage_id in stages:
		PlayerData.clear_stage(stage_id, 3)
	print("[CHEAT] Cleared all stages")
```

**Step 2: Add to project.godot autoloads**

Add line:
```
CheatManager="*res://scripts/core/cheat_manager.gd"
```

**Step 3: Test**

Run: Launch game, press F12 on any screen
Expected: Cheat panel appears with working buttons

**Step 4: Commit**

```bash
git add scripts/core/cheat_manager.gd project.godot
git commit -m "feat: add global CheatManager accessible from any screen"
```

---

## Task 10: Polish Team Select Screen UI

**Files:**
- Modify: `scripts/ui/team_select_screen.gd`
- Test: Manual - verify improved visuals

**Step 1: Use sprite-based panels for team slots**

In `_create_empty_slot()` and `_update_team_slot()`, use `UISpriteLoader.apply_panel_style()` instead of plain StyleBoxFlat.

**Step 2: Improve selected unit highlighting**

Add glow effect or stronger border for selected units.

**Step 3: Test**

Run: Go to Team Select
Expected: More polished card visuals with clear selection state

**Step 4: Commit**

```bash
git add scripts/ui/team_select_screen.gd
git commit -m "style: polish team select screen UI"
```

---

## Task 11: Polish Dungeon Select Screen UI

**Files:**
- Modify: `scripts/ui/dungeon_select_screen.gd`
- Test: Manual - verify improved visuals

**Step 1: Use sprite-based panels and buttons**

Replace `UITheme.create_panel_style()` calls with `UISpriteLoader.apply_panel_style()`.

**Step 2: Add background theme**

In `_apply_theme()`, add:
```gdscript
UISpriteLoader.apply_background_to_scene(self, UISpriteLoader.BackgroundTheme.RUINS, UISpriteLoader.BackgroundVariant.PALE, 0.4)
```

**Step 3: Test**

Run: Go to Dungeons
Expected: Themed background, polished card visuals

**Step 4: Commit**

```bash
git add scripts/ui/dungeon_select_screen.gd
git commit -m "style: polish dungeon select screen UI"
```

---

## Task 12: Polish Summon Screen UI

**Files:**
- Modify: `scripts/ui/gacha_screen.gd`
- Test: Manual - test full summon flow

**Step 1: Improve banner display**

Add pity counter more prominently, show current rates.

**Step 2: Improve results display**

Add star rating display under each revealed unit in results.

**Step 3: Enhance reveal animation**

The animation system exists - just verify it's working and tweak timing if needed.

**Step 4: Test**

Run: Do single and 10x pulls
Expected: Smooth animations, clear results display

**Step 5: Commit**

```bash
git add scripts/ui/gacha_screen.gd
git commit -m "style: polish summon screen UI and animations"
```

---

## Task 13: Update Battle Boards for Dungeons

**Files:**
- Modify: `scripts/core/board_asset_loader.gd`
- Modify: `scripts/battle/battle.gd` (if board selection logic exists)
- Test: Manual - run dungeon battles

**Step 1: Add dungeon-specific board selection**

In battle.gd `_ready()`, check `PlayerData.is_dungeon_mode()` and select board based on dungeon stat type:

```gdscript
func _get_board_theme() -> String:
	if PlayerData.is_dungeon_mode() and PlayerData.current_dungeon:
		match PlayerData.current_dungeon.drops_stat_type:
			GearData.StatType.HP:
				return "nature"  # Forest/nature theme
			GearData.StatType.ATTACK:
				return "fire"  # Volcanic theme
			GearData.StatType.DEFENSE:
				return "stone"  # Fortress theme
			GearData.StatType.SPEED:
				return "wind"  # Sky theme
	return "default"
```

**Step 2: Verify BoardAssetLoader has themes**

Check what themes are available and map accordingly.

**Step 3: Test**

Run: Start each dungeon type, verify board matches theme

**Step 4: Commit**

```bash
git add scripts/battle/battle.gd scripts/core/board_asset_loader.gd
git commit -m "feat: add dungeon-specific battle board themes"
```

---

## Task 14: Polish Unit Card Info UI

**Files:**
- Modify: `scripts/ui/collection_screen.gd` (detail panel section)
- Test: Manual - click unit, verify detail panel looks good

**Step 1: Add stat icons**

Use text icons or sprites for HP/ATK/DEF/SPD in the detail stats display.

**Step 2: Show CP prominently**

Add CP display in detail panel.

**Step 3: Improve gear slots display**

Make gear slots more visually distinct with type icons.

**Step 4: Test**

Run: Go to Collection, click a unit
Expected: Clean detail panel with stat icons, CP, gear slots

**Step 5: Commit**

```bash
git add scripts/ui/collection_screen.gd
git commit -m "style: polish unit card detail panel UI"
```

---

## Task 15: Final Integration and Version Update

**Files:**
- Modify: `CLAUDE.md` (update with new systems)
- Modify: `project.godot` (bump version if applicable)
- Test: Full playthrough

**Step 1: Update CLAUDE.md**

Add:
- CheatManager autoload
- CurrencyBar component
- Combat Power (CP) system
- Auto-select team feature

**Step 2: Test full game flow**

- Launch game
- Check achievements (should show 9)
- Pull units, verify CP shows
- Use auto-select in team select
- Test gear tap in both screens
- Test cheat menu (F12) everywhere
- Verify currency bar on all screens
- Run dungeons, verify themed boards

**Step 3: Commit**

```bash
git add CLAUDE.md
git commit -m "docs: update CLAUDE.md for v0.18.1"
git commit -m "feat: complete v0.18.1 Bug Fixes & Polish Update"
```

---

## Summary

| Task | Description | Estimated Complexity |
|------|-------------|---------------------|
| 1 | Fix achievements loading | Simple |
| 2 | Fix gear card tap | Simple |
| 3 | Add CP calculation | Simple |
| 4 | Add auto-select team | Medium |
| 5 | Add CP to unit cards | Simple |
| 6 | Create CurrencyBar component | Medium |
| 7 | Add CurrencyBar to screens | Simple (repetitive) |
| 8 | Add gear icons | Simple |
| 9 | Create CheatManager | Medium |
| 10 | Polish team select UI | Simple |
| 11 | Polish dungeon select UI | Simple |
| 12 | Polish summon screen UI | Medium |
| 13 | Add dungeon battle boards | Medium |
| 14 | Polish unit card detail UI | Simple |
| 15 | Final integration | Simple |

Total: 15 tasks, mostly simple with a few medium complexity items.
