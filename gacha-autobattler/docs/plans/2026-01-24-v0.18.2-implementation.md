# v0.18.2 Board Generator Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Create a board generator tool that produces polished battle board images using existing tileset assets.

**Architecture:** Standalone Godot scene with generator script that composites tileset sprites layer-by-layer, captures via SubViewport, and saves as PNG files.

**Tech Stack:** Godot 4.5, GDScript, SubViewport for image capture

---

## Task 1: Create Generator Scene Structure

**Files:**
- Create: `scenes/tools/board_generator.tscn`
- Create: `scripts/tools/board_generator.gd`

**Step 1: Create the directory structure**

Run: Create `scenes/tools/` and `scripts/tools/` directories if they don't exist.

**Step 2: Create the base scene file**

Create `scenes/tools/board_generator.tscn` with:
- Root Node2D named "BoardGenerator"
- SubViewport child (1200x1120) named "CaptureViewport"
- Node2D inside SubViewport named "BoardRoot" (this holds generated content)
- UI layer with "Generate" button and status label

**Step 3: Create the script skeleton**

Create `scripts/tools/board_generator.gd` with:

```gdscript
extends Node2D

const BOARD_WIDTH = 1200
const BOARD_HEIGHT = 1120
const TILE_SIZE = 16
const OUTPUT_PATH = "res://assets/board/boards/"

# Safe zone where decorations are sparse (center play area)
const CENTER_SAFE_ZONE = Rect2(300, 260, 600, 600)

@onready var capture_viewport: SubViewport = $CaptureViewport
@onready var board_root: Node2D = $CaptureViewport/BoardRoot
@onready var status_label: Label = $UI/StatusLabel

var themes: Dictionary = {}

func _ready():
    _init_themes()

func _init_themes():
    pass  # Will define theme data

func generate_all_boards():
    pass  # Will implement generation loop

func _on_generate_pressed():
    generate_all_boards()
```

**Step 4: Verify scene runs without errors**

Run: Open scene in editor, verify no errors.

**Step 5: Commit**

```bash
git add scenes/tools/ scripts/tools/
git commit -m "feat: add board generator scene structure"
```

---

## Task 2: Implement Theme Data Structures

**Files:**
- Modify: `scripts/tools/board_generator.gd`

**Step 1: Define forest theme data**

Add to `_init_themes()`:

```gdscript
func _init_themes():
    themes["forest"] = {
        "base_texture": "res://assets/board/forest tileset/grass.png",
        "base_color": Color(0.486, 0.678, 0.227),  # Grass green fallback
        "decorations": [
            "res://assets/board/forest tileset/decor_bush1.png",
            "res://assets/board/forest tileset/decor_bush2.png",
            "res://assets/board/forest tileset/decor_bush3.png",
            "res://assets/board/forest tileset/decor_grass1.png",
            "res://assets/board/forest tileset/decor_grass2.png",
            "res://assets/board/forest tileset/decor_mushroom1.png",
            "res://assets/board/forest tileset/decor_mushroom2.png",
            "res://assets/board/forest tileset/decor_stone1.png",
            "res://assets/board/forest tileset/decor_stone2.png",
        ],
        "decoration_density": 40,  # Number of decorations to place
        "border_color": Color(0.2, 0.4, 0.1),  # Darker green for tree area
    }
```

**Step 2: Define dungeon theme data**

```gdscript
    themes["dungeon"] = {
        "base_texture": "res://assets/board/Tiles/Dungeon_WallsAndFloors.png",
        "base_color": Color(0.3, 0.35, 0.3),  # Stone gray
        "decorations": [],  # Will add dungeon decorations later
        "decoration_density": 20,
        "border_color": Color(0.15, 0.15, 0.2),  # Dark wall color
    }
```

**Step 3: Define dark forest theme data**

```gdscript
    themes["dark_forest"] = {
        "base_texture": "res://assets/board/forest tileset/grass_dark.png",
        "base_color": Color(0.3, 0.45, 0.2),  # Darker grass
        "decorations": [
            "res://assets/board/forest tileset/decor_bush1_purple.png",
            "res://assets/board/forest tileset/decor_bush2_purple.png",
            "res://assets/board/forest tileset/decor_bush3_purple.png",
            "res://assets/board/forest tileset/decor_mushroom1.png",
            "res://assets/board/forest tileset/decor_mushroom2.png",
            "res://assets/board/forest tileset/decor_stone1.png",
        ],
        "decoration_density": 50,
        "border_color": Color(0.1, 0.2, 0.1),
    }
```

**Step 4: Commit**

```bash
git add scripts/tools/board_generator.gd
git commit -m "feat: add theme data structures for board generator"
```

---

## Task 3: Implement Base Terrain Layer

**Files:**
- Modify: `scripts/tools/board_generator.gd`

**Step 1: Add helper to clear board**

```gdscript
func _clear_board():
    for child in board_root.get_children():
        child.queue_free()
    await get_tree().process_frame
```

**Step 2: Implement base terrain fill**

```gdscript
func _fill_base_terrain(theme: Dictionary):
    # Create colored background as base
    var bg = ColorRect.new()
    bg.color = theme["base_color"]
    bg.size = Vector2(BOARD_WIDTH, BOARD_HEIGHT)
    board_root.add_child(bg)

    # Add subtle variation with noise-like pattern
    var variation_rect = ColorRect.new()
    variation_rect.color = theme["border_color"]
    variation_rect.color.a = 0.3
    variation_rect.size = Vector2(BOARD_WIDTH, 200)
    variation_rect.position = Vector2(0, 0)
    board_root.add_child(variation_rect)
```

**Step 3: Add grass texture tiling (for forest themes)**

```gdscript
func _tile_texture(texture_path: String, scale_factor: float = 4.0):
    var texture = load(texture_path) as Texture2D
    if not texture:
        return

    var tex_size = texture.get_size() * scale_factor
    var cols = ceili(BOARD_WIDTH / tex_size.x)
    var rows = ceili(BOARD_HEIGHT / tex_size.y)

    for row in rows:
        for col in cols:
            var sprite = Sprite2D.new()
            sprite.texture = texture
            sprite.scale = Vector2(scale_factor, scale_factor)
            sprite.centered = false
            sprite.position = Vector2(col * tex_size.x, row * tex_size.y)
            board_root.add_child(sprite)
```

**Step 4: Commit**

```bash
git add scripts/tools/board_generator.gd
git commit -m "feat: implement base terrain layer for board generator"
```

---

## Task 4: Implement Border Elements

**Files:**
- Modify: `scripts/tools/board_generator.gd`

**Step 1: Add border drawing function**

```gdscript
func _add_borders(theme: Dictionary):
    # Top border (thicker, represents tree line / wall)
    var top_border = ColorRect.new()
    top_border.color = theme["border_color"]
    top_border.size = Vector2(BOARD_WIDTH, 180)
    top_border.position = Vector2(0, 0)
    board_root.add_child(top_border)

    # Left border
    var left_border = ColorRect.new()
    left_border.color = theme["border_color"]
    left_border.size = Vector2(120, BOARD_HEIGHT)
    left_border.position = Vector2(0, 0)
    board_root.add_child(left_border)

    # Right border
    var right_border = ColorRect.new()
    right_border.color = theme["border_color"]
    right_border.size = Vector2(120, BOARD_HEIGHT)
    right_border.position = Vector2(BOARD_WIDTH - 120, 0)
    board_root.add_child(right_border)
```

**Step 2: Add gradient transition from border to play area**

```gdscript
func _add_border_gradient(theme: Dictionary):
    # Create softer transitions using semi-transparent rects
    var gradient_color = theme["border_color"]
    gradient_color.a = 0.5

    # Top gradient
    var top_grad = ColorRect.new()
    top_grad.color = gradient_color
    top_grad.size = Vector2(BOARD_WIDTH, 60)
    top_grad.position = Vector2(0, 180)
    board_root.add_child(top_grad)
```

**Step 3: Commit**

```bash
git add scripts/tools/board_generator.gd
git commit -m "feat: implement border elements for board generator"
```

---

## Task 5: Implement Decoration Scattering

**Files:**
- Modify: `scripts/tools/board_generator.gd`

**Step 1: Add decoration loading**

```gdscript
func _load_decorations(paths: Array) -> Array[Texture2D]:
    var textures: Array[Texture2D] = []
    for path in paths:
        var tex = load(path) as Texture2D
        if tex:
            textures.append(tex)
    return textures
```

**Step 2: Add scatter function with safe zone avoidance**

```gdscript
func _scatter_decorations(theme: Dictionary, rng: RandomNumberGenerator):
    var decorations = _load_decorations(theme["decorations"])
    if decorations.is_empty():
        return

    var placed_positions: Array[Vector2] = []
    var count = theme["decoration_density"]

    for i in count:
        var pos = Vector2(
            rng.randf_range(50, BOARD_WIDTH - 50),
            rng.randf_range(50, BOARD_HEIGHT - 50)
        )

        # Reduce chance of placement in center safe zone
        if CENTER_SAFE_ZONE.has_point(pos):
            if rng.randf() > 0.2:  # 80% chance to skip
                continue

        # Check minimum distance from other decorations
        var too_close = false
        for placed in placed_positions:
            if pos.distance_to(placed) < 40:
                too_close = true
                break

        if too_close:
            continue

        # Place decoration
        var sprite = Sprite2D.new()
        sprite.texture = decorations[rng.randi() % decorations.size()]
        sprite.position = pos
        sprite.scale = Vector2(2.0, 2.0)  # Scale up pixel art
        board_root.add_child(sprite)
        placed_positions.append(pos)
```

**Step 3: Commit**

```bash
git add scripts/tools/board_generator.gd
git commit -m "feat: implement decoration scattering for board generator"
```

---

## Task 6: Implement Image Capture and Save

**Files:**
- Modify: `scripts/tools/board_generator.gd`

**Step 1: Add capture function**

```gdscript
func _capture_board() -> Image:
    await RenderingServer.frame_post_draw
    var image = capture_viewport.get_texture().get_image()
    return image
```

**Step 2: Add save function**

```gdscript
func _save_board(image: Image, filename: String):
    var path = OUTPUT_PATH + filename
    var error = image.save_png(path)
    if error != OK:
        push_error("Failed to save board: " + path)
    else:
        print("Saved: " + path)
```

**Step 3: Implement single board generation**

```gdscript
func generate_board(theme_name: String, variation: int) -> void:
    var theme = themes[theme_name]
    var rng = RandomNumberGenerator.new()
    rng.seed = hash(theme_name) + variation  # Deterministic per variation

    await _clear_board()

    _fill_base_terrain(theme)
    _add_borders(theme)
    _add_border_gradient(theme)
    _scatter_decorations(theme, rng)

    await get_tree().process_frame

    var image = await _capture_board()
    var filename = "%s_%d.png" % [theme_name, variation]
    _save_board(image, filename)
```

**Step 4: Commit**

```bash
git add scripts/tools/board_generator.gd
git commit -m "feat: implement image capture and save for board generator"
```

---

## Task 7: Implement Full Generation Loop

**Files:**
- Modify: `scripts/tools/board_generator.gd`

**Step 1: Implement generate all boards**

```gdscript
func generate_all_boards():
    status_label.text = "Generating boards..."

    var theme_names = ["forest", "dungeon", "dark_forest"]
    var variations = 3

    for theme_name in theme_names:
        for v in range(1, variations + 1):
            status_label.text = "Generating %s_%d..." % [theme_name, v]
            await generate_board(theme_name, v)
            await get_tree().process_frame

    status_label.text = "Done! Generated %d boards." % (theme_names.size() * variations)
    print("Board generation complete!")
```

**Step 2: Connect button signal**

In `_ready()` or via editor, connect Generate button to `_on_generate_pressed`:

```gdscript
func _on_generate_pressed():
    generate_all_boards()
```

**Step 3: Run generator and verify output**

Run: Open and run `board_generator.tscn`, click Generate.
Expected: 9 PNG files created in `assets/board/boards/`

**Step 4: Commit**

```bash
git add scripts/tools/board_generator.gd
git commit -m "feat: implement full board generation loop"
```

---

## Task 8: Update Battle System to Use New Boards

**Files:**
- Modify: `scripts/battle/battle.gd`

**Step 1: Update board path configuration**

Replace the hardcoded board arrays with new structure:

```gdscript
const CHAPTER_BOARDS = {
    1: [
        "res://assets/board/boards/forest_1.png",
        "res://assets/board/boards/forest_2.png",
        "res://assets/board/boards/forest_3.png"
    ],
    2: [
        "res://assets/board/boards/dungeon_1.png",
        "res://assets/board/boards/dungeon_2.png",
        "res://assets/board/boards/dungeon_3.png"
    ],
    3: [
        "res://assets/board/boards/dark_forest_1.png",
        "res://assets/board/boards/dark_forest_2.png",
        "res://assets/board/boards/dark_forest_3.png"
    ]
}
```

**Step 2: Update board selection logic**

Modify `_ready()` or board setup to pick from chapter-appropriate arrays with random variation:

```gdscript
func _get_board_for_chapter(chapter: int) -> String:
    if chapter in CHAPTER_BOARDS:
        var boards = CHAPTER_BOARDS[chapter]
        return boards[randi() % boards.size()]
    return CHAPTER_BOARDS[1][0]  # Fallback to forest

# For quick battle, pick from all boards
func _get_random_board() -> String:
    var all_boards = []
    for boards in CHAPTER_BOARDS.values():
        all_boards.append_array(boards)
    return all_boards[randi() % all_boards.size()]
```

**Step 3: Test campaign and quick battle**

Run: Play campaign stage 1-1, verify forest board appears.
Run: Play quick battle multiple times, verify different boards appear.

**Step 4: Commit**

```bash
git add scripts/battle/battle.gd
git commit -m "feat: update battle system to use generated boards"
```

---

## Task 9: Cleanup Old Board Files

**Files:**
- Delete: `assets/board/boards/chapter_1_board.png`
- Delete: `assets/board/boards/chapter_2_board.png`
- Delete: `assets/board/boards/chapter_3_board.png`
- Delete: `assets/board/forest_board.png` (if exists)
- Delete: `assets/board/dungeon_board.png` (if exists)

**Step 1: Verify new boards work correctly**

Run: Test campaign chapters 1, 2, 3 and quick battle.
Expected: All battles use new generated boards without errors.

**Step 2: Remove old board files**

```bash
rm assets/board/boards/chapter_1_board.png
rm assets/board/boards/chapter_2_board.png
rm assets/board/boards/chapter_3_board.png
```

**Step 3: Update battle.tscn default texture**

Change the default GameBoard texture reference to a new board.

**Step 4: Commit**

```bash
git add -A
git commit -m "chore: remove old board files, use generated boards"
```

---

## Task 10: Final Polish and Testing

**Step 1: Run full playtest**

- Campaign: All 15 stages
- Quick Battle: 5+ battles
- Dungeons: All 4 dungeons

**Step 2: Adjust generation parameters if needed**

If boards look too sparse/dense, adjust:
- `decoration_density` values
- Border sizes
- Color values

**Step 3: Final commit**

```bash
git add -A
git commit -m "feat: complete v0.18.2 board generator system"
```

---

## Summary

After completing all tasks:
- New board generator tool in `scenes/tools/board_generator.tscn`
- 9 generated board images (3 themes x 3 variations)
- Battle system updated to use new boards with random variation
- Old broken/repetitive boards removed
